## Embedding Google Charts
_SA Author_: [Britton LaRoche](mailto:britton.laroche@mongodb.com)   
(Note this tutorial build's on the [Employee Tutorial](../employee))

### Tutorial Contents 
1. [MongoDB blog tutorial](https://docs.mongodb.com/stitch/tutorials/blog-overview/)
2. [Atlas Triggers and Functions: Employee tutorial](https://github.com/brittonlaroche/MongoDB-Demos/edit/master/Stitch/employee/)
3. [Stitch Query Anywhere tutorial](https://github.com/brittonlaroche/MongoDB-Demos/edit/master/Stitch/rest)
4. [Embed Atlas Charts in your app tutorial](https://github.com/brittonlaroche/MongoDB-Demos/edit/master/Stitch/charts)
5. [Embed Google Charts tutorial](https://github.com/brittonlaroche/MongoDB-Demos/edit/master/Stitch/charts-google) 
6. [Embed an Org Chart tutorial](https://github.com/brittonlaroche/MongoDB-Demos/edit/master/Stitch/charts-org) 
7. [Host your application tutorial](https://github.com/brittonlaroche/MongoDB-Demos/edit/master/Stitch/hosting) 

### Google charts overview 

The [Google charts](https://developers.google.com/chart/interactive/docs/quick_start) javascript library has a number of easily imported charting functions that you can imbed in your stitch application with minimal coding effort.  In this tutorial we show how to embed a google pie and column chart into your basic employee application.  The data is loaded directly from stitch into a data object that is passed into the draw chart function.

The result is shown below:
![Google Charts](img/googleChart.jpg "Google Charts")

Google charts are a good alternative to Atlas charts, but they do require coding and additional effort to set up.  Atlas charts require no code and can be easily created in an intuitive interface and easily embeded as an iframe.  This tutorial is merely to show another method of adding another set of charts to your application.

No effort was put into beautifying the html page, no css or framework was added to the html, to keep it in its most simple and pure form. The image above was generated by selecting "file/print" from the browser menu. It may not be pretty, but its simple, elegant and powerful.  Lets get started.  

### Source file
The completed source file is in the link here [Employee Google Charts](employeeGoogleChart.html), you can click the link and copy the html into a text editor.  Change 'your-app-id' to the application displayed in your stitch console.  

```
const client = stitch.Stitch.initializeDefaultAppClient('your-app-id');
```

Save the file as employeeChartsGoogle.html and double click to see the reports generated for your employee application.  The rest of this tutorial explains how to create this file from the original [employee.html](../employee/employee.html) covered in the [Atlas Triggers and Functions: Employee tutorial](https://github.com/brittonlaroche/MongoDB-Demos/edit/master/Stitch/employee/)

### 1. Count of employees by department
The first step is to gather the data required by the charts.  The charts will display a count of employees by department.  Lets begin by creating a new function to count the employees by department and display the results as a table.

```
<script>
...
	function displayEmployeeCounts() {
		//We will aggregate the employee data by department and create a table with totals
		const tStrt = "<div><table><tr><th>Department</th><th>Number of Employees</th></tr>";
		const cEmployees = db.collection("employees");
		cEmployees.aggregate([{"$group":{"_id":"$department","num_employees":{"$sum":1}}}]).asArray()
		    .then(docs => {
		      	const html = docs.map(c => "<tr><td>" +
		      	c._id +  "</td><td>" +
		      	c.num_employees + "</td><td>" +
		      	"</tr>").join("");
		      	document.getElementById("employee_counts").innerHTML = tStrt + html + "</table></div>";
		    });
	}
</script>
```

Next we add a div tag ```<div id="employee_counts"></div>``` to contain the "employee_counts" table.

```
...
     <input type="submit" onClick="addEmployee()">
      <hr>
	  <div id="employee_counts"></div>
      <hr>
	  Employee List:
      <hr>
	  <div id="employees"></div>
  </body>
...
```

After the java script code and div are added to the html we are now ready to call the function from the load function already in place, we simply add ```.then(displayEmployeeCounts)```.

```
<script>
...
        function displayEmployeesOnLoad() {
          client.auth
            .loginWithCredential(new stitch.AnonymousCredential())
            .then(displayEmployeeCounts)
            .then(displayEmployees)
            .catch(console.error);
        }
...
</script>
```
Save the modified html file and double click it, or refresh the browser to see the employee counts by department.

### 2. Creating google charts
Google charts are created in three steps.  The first step requires importing the javascript library form google.  Next we specify the chart type.  We then load the chart data into a data table object and pass that data object into the charts draw function. Lets begin by importing the chart's java script library from gooogle.  We add the import in the header section of the html right after we import the stitch sdk.

```
<html>
  <head>
    <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.4.0/stitch.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    ...
```

Next we load the corechart package ```google.charts.load('current', {'packages':['corechart']});``` as we initialize variables for all our functions.

```
<html>
  <head>
    <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.4.0/stitch.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        const client = stitch.Stitch.initializeDefaultAppClient('your-app-id');
        const db = client.getServiceClient(stitch.RemoteMongoClient.factory,
        "mongodb-atlas").db('HR');
	google.charts.load('current', {'packages':['corechart']});
	...
```

Now that we have the chart objects loaded its time to write the aggregation function to load the chart data and draw the chart.

```
	function drawEmployeeCountChart() {
		var chartPie = new google.visualization.PieChart(document.getElementById('employee_piechart'));
		var chartColumn = new google.visualization.ColumnChart(document.getElementById('employee_columnchart'));
		var data = new google.visualization.DataTable();
		data.addColumn('string', 'Department');
		data.addColumn('number', 'EmployeeCount');
		//Get the data to draw the chart from MongoDB, aggregate the employee data by department
		const cEmployees = db.collection("employees");
		cEmployees.aggregate([{"$group":{"_id":"$department","num_employees":{"$sum":1}}}]).asArray()
	     	.then(docs => {
			docs.forEach( function(myDoc) {
				data.addRow([ myDoc._id , myDoc.num_employees ] );
			});
			// Create the chart.
			var options = {
				title: 'Employee Counts By Department',
				is3D: true,
				allowHtml:true
			};
			chartPie.draw(data, options);
			chartColumn.draw(data, options);
		});
	}
```
